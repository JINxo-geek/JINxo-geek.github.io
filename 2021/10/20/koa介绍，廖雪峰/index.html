<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>koa2 | Hexo</title><meta name="keywords" content="koa2"><meta name="author" content="JINxo"><meta name="copyright" content="JINxo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="koa2基础">
<meta property="og:type" content="article">
<meta property="og:title" content="koa2">
<meta property="og:url" content="http://example.com/2021/10/20/koa%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%BB%96%E9%9B%AA%E5%B3%B0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="koa2基础">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-10-19T17:01:25.495Z">
<meta property="article:modified_time" content="2021-10-19T17:01:25.496Z">
<meta property="article:author" content="JINxo">
<meta property="article:tag" content="koa2">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2021/10/20/koa%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%BB%96%E9%9B%AA%E5%B3%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'koa2',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-10-20 01:01:25'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">54</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">23</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Hexo</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">koa2</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-10-19T17:01:25.495Z" title="Created 2021-10-20 01:01:25">2021-10-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-10-19T17:01:25.496Z" title="Updated 2021-10-20 01:01:25">2021-10-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="koa2"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>koa2基础</p>
<span id="more"></span>



<p>来自 ：廖雪峰的js全栈教程：<a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000">https://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000</a></p>
<h1 id="基础回顾"><a href="#基础回顾" class="headerlink" title="基础回顾"></a>基础回顾</h1><p>中间件的有个核心语句那就是<code>await next()</code> ,<code>koa</code> 将异步函数封装成链式，通过next()调用下个异步函数，这些异步函数被为中间件。<code>await</code> 是ES6的语法，实际上是generator的语法糖。<br>generator看上去像一个函数，但是可以返回多次， ES6定义generator标准的哥们借鉴了Python的generator的概念和语法，如果你对Python的generator很熟悉，那么ES6的generator就是小菜一碟了。 </p>
<p>我们先复习函数的概念，一个函数就是一个完整的代码，调用一个函数就是传入参数，然后返回结果。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x+x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> r = foo(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>函数在执行过程中，如果没有遇到<code>return</code>语句（函数末尾如果没有<code>return</code>，就是隐含的<code>return undefined;</code>），控制权无法交回被调用的代码。 </p>
<p>generator跟函数很像，定义如下： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">foo</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> x + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">yield</span> x + <span class="number">2</span>；</span><br><span class="line">    <span class="keyword">return</span> x + <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>generator 和函数不同的是，generator 由 <code>function*</code> 定义，注意多处的* 号，并且，除了return语句，还可以用yield 返回多次。<br>返回多次有啥用？</p>
<p>我们以一个著名的斐波那契数列为例，它由<code>0</code>，<code>1</code>开头： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 1 2 3 5 8 13 21 34 ...</span><br></pre></td></tr></table></figure>

<p>要编写一个产生斐波那契数列的函数，可以这么写： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fib</span>(<span class="params">max</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span></span><br><span class="line">        t,</span><br><span class="line">        a = <span class="number">0</span>,</span><br><span class="line">        b = <span class="number">1</span>,</span><br><span class="line">        arr = [<span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">while</span> (arr.length &lt; max) &#123;</span><br><span class="line">        [a, b] = [b, a + b];</span><br><span class="line">        arr.push(b);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试:</span></span><br><span class="line">fib(<span class="number">5</span>); <span class="comment">// [0, 1, 1, 2, 3]</span></span><br><span class="line">fib(<span class="number">10</span>); <span class="comment">// [0, 1, 1, 2, 3, 5, 8, 13, 21, 34]</span></span><br></pre></td></tr></table></figure>

<p>函数只能返回一次，所以必须返回一个<code>Array</code>。但是，如果换成generator，就可以一次返回一个数，不断返回多次。用generator改写如下： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">fib</span>(<span class="params">max</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span></span><br><span class="line">        t,</span><br><span class="line">        a = <span class="number">0</span>,</span><br><span class="line">        b = <span class="number">1</span>,</span><br><span class="line">        n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (n &lt; max) &#123;</span><br><span class="line">        <span class="keyword">yield</span> a;</span><br><span class="line">        [a, b] = [b, a + b];</span><br><span class="line">        n ++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">fib(<span class="number">5</span>); <span class="comment">// fib &#123;[[GeneratorStatus]]: &quot;suspended&quot;, [[GeneratorReceiver]]: Window&#125;</span></span><br></pre></td></tr></table></figure>

<p>直接调用一个generator和调用函数不一样，<code>fib(5)</code>仅仅是创建了一个generator对象，还没有去执行它。</p>
<p>调用generator对象有两个方法，一是不断地调用generator对象的<code>next()</code>方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> f = fib(<span class="number">5</span>);</span><br><span class="line">f.next(); <span class="comment">// &#123;value: 0, done: false&#125;</span></span><br><span class="line">f.next(); <span class="comment">// &#123;value: 1, done: false&#125;</span></span><br><span class="line">f.next(); <span class="comment">// &#123;value: 1, done: false&#125;</span></span><br><span class="line">f.next(); <span class="comment">// &#123;value: 2, done: false&#125;</span></span><br><span class="line">f.next(); <span class="comment">// &#123;value: 3, done: false&#125;</span></span><br><span class="line">f.next(); <span class="comment">// &#123;value: undefined, done: true&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>next()</code>方法会执行generator的代码，然后，每次遇到<code>yield x;</code>就返回一个对象<code>&#123;value: x, done: true/false&#125;</code>，然后“暂停”。返回的<code>value</code>就是<code>yield</code>的返回值，<code>done</code>表示这个generator是否已经执行结束了。如果<code>done</code>为<code>true</code>，则<code>value</code>就是<code>return</code>的返回值。</p>
<p>当执行到<code>done</code>为<code>true</code>时，这个generator对象就已经全部执行完毕，不要再继续调用<code>next()</code>了。</p>
<p>第二个方法是直接用<code>for ... of</code>循环迭代generator对象，这种方式不需要我们自己判断<code>done</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> x <span class="keyword">of</span> fib(<span class="number">10</span>)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(x); <span class="comment">// 依次输出0, 1, 1, 2, 3, ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="generator"><a href="#generator" class="headerlink" title="generator"></a>generator</h4><p>阅读: 91002</p>
<hr>
<p>generator（生成器）是ES6标准引入的新的数据类型。一个generator看上去像一个函数，但可以返回多次。</p>
<p>ES6定义generator标准的哥们借鉴了Python的generator的概念和语法，如果你对Python的generator很熟悉，那么ES6的generator就是小菜一碟了。如果你对Python还不熟，赶快恶补<a target="_blank" rel="noopener" href="http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014317799226173f45ce40636141b6abc8424e12b5fb27000">Python教程</a>！。</p>
<p>我们先复习函数的概念。一个函数是一段完整的代码，调用一个函数就是传入参数，然后返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function foo(x) &#123;</span><br><span class="line">    return x + x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var r = foo(1); // 调用foo函数</span><br></pre></td></tr></table></figure>

<p>函数在执行过程中，如果没有遇到<code>return</code>语句（函数末尾如果没有<code>return</code>，就是隐含的<code>return undefined;</code>），控制权无法交回被调用的代码。</p>
<p>generator跟函数很像，定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function* foo(x) &#123;</span><br><span class="line">    yield x + 1;</span><br><span class="line">    yield x + 2;</span><br><span class="line">    return x + 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>generator和函数不同的是，generator由<code>function*</code>定义（注意多出的<code>*</code>号），并且，除了<code>return</code>语句，还可以用<code>yield</code>返回多次。</p>
<p>大多数同学立刻就晕了，generator就是能够返回多次的“函数”？返回多次有啥用？</p>
<p>还是举个栗子吧。</p>
<p>我们以一个著名的斐波那契数列为例，它由<code>0</code>，<code>1</code>开头：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 1 2 3 5 8 13 21 34 ...</span><br></pre></td></tr></table></figure>

<p>要编写一个产生斐波那契数列的函数，可以这么写：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function fib(max) &#123;</span><br><span class="line">    var</span><br><span class="line">        t,</span><br><span class="line">        a = 0,</span><br><span class="line">        b = 1,</span><br><span class="line">        arr = [0, 1];</span><br><span class="line">    while (arr.length &lt; max) &#123;</span><br><span class="line">        [a, b] = [b, a + b];</span><br><span class="line">        arr.push(b);</span><br><span class="line">    &#125;</span><br><span class="line">    return arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 测试:</span><br><span class="line">fib(5); // [0, 1, 1, 2, 3]</span><br><span class="line">fib(10); // [0, 1, 1, 2, 3, 5, 8, 13, 21, 34]</span><br></pre></td></tr></table></figure>

<p>函数只能返回一次，所以必须返回一个<code>Array</code>。但是，如果换成generator，就可以一次返回一个数，不断返回多次。用generator改写如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function* fib(max) &#123;</span><br><span class="line">    var</span><br><span class="line">        t,</span><br><span class="line">        a = 0,</span><br><span class="line">        b = 1,</span><br><span class="line">        n = 0;</span><br><span class="line">    while (n &lt; max) &#123;</span><br><span class="line">        yield a;</span><br><span class="line">        [a, b] = [b, a + b];</span><br><span class="line">        n ++;</span><br><span class="line">    &#125;</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接调用试试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fib(5); // fib &#123;[[GeneratorStatus]]: &quot;suspended&quot;, [[GeneratorReceiver]]: Window&#125;</span><br></pre></td></tr></table></figure>

<p>直接调用一个generator和调用函数不一样，<code>fib(5)</code>仅仅是创建了一个generator对象，还没有去执行它。</p>
<p>调用generator对象有两个方法，一是不断地调用generator对象的<code>next()</code>方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var f = fib(5);</span><br><span class="line">f.next(); // &#123;value: 0, done: false&#125;</span><br><span class="line">f.next(); // &#123;value: 1, done: false&#125;</span><br><span class="line">f.next(); // &#123;value: 1, done: false&#125;</span><br><span class="line">f.next(); // &#123;value: 2, done: false&#125;</span><br><span class="line">f.next(); // &#123;value: 3, done: false&#125;</span><br><span class="line">f.next(); // &#123;value: undefined, done: true&#125;</span><br></pre></td></tr></table></figure>

<p><code>next()</code>方法会执行generator的代码，然后，每次遇到<code>yield x;</code>就返回一个对象<code>&#123;value: x, done: true/false&#125;</code>，然后“暂停”。返回的<code>value</code>就是<code>yield</code>的返回值，<code>done</code>表示这个generator是否已经执行结束了。如果<code>done</code>为<code>true</code>，则<code>value</code>就是<code>return</code>的返回值。</p>
<p>当执行到<code>done</code>为<code>true</code>时，这个generator对象就已经全部执行完毕，不要再继续调用<code>next()</code>了。</p>
<p>第二个方法是直接用<code>for ... of</code>循环迭代generator对象，这种方式不需要我们自己判断<code>done</code>：</p>
<p><code>&#39;use strict&#39;  function* fib(max) &#123;     var         t,         a = 0,         b = 1,         n = 0;     while (n &lt; max) &#123;         yield a;         [a, b] = [b, a + b];         n ++;     &#125;     return; &#125; </code> Run</p>
<p>generator和普通函数相比，有什么用？</p>
<p>因为generator可以在执行过程中多次返回，所以它看上去就像一个可以记住执行状态的函数，利用这一点，写一个generator就可以实现需要用面向对象才能实现的功能。例如，用一个对象来保存状态，得这么写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fib = &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">b</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">n</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">max</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">next</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span></span><br><span class="line">            r = <span class="built_in">this</span>.a,</span><br><span class="line">            t = <span class="built_in">this</span>.a + <span class="built_in">this</span>.b;</span><br><span class="line">        <span class="built_in">this</span>.a = <span class="built_in">this</span>.b;</span><br><span class="line">        <span class="built_in">this</span>.b = t;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.n &lt; <span class="built_in">this</span>.max) &#123;</span><br><span class="line">            <span class="built_in">this</span>.n ++;</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>用对象的属性来保存状态，相当繁琐。 </p>
<p>generator还有另一个巨大的好处，就是把异步回调代码变成“同步”代码。这个好处要等到后面学了AJAX以后才能体会到。</p>
<p>没有generator之前的黑暗时代，用AJAX时需要这么写代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ajax(<span class="string">&#x27;http://url-1&#x27;</span>, data1, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> handle(err);</span><br><span class="line">    &#125;</span><br><span class="line">    ajax(<span class="string">&#x27;http://url-2&#x27;</span>, data2, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> handle(err);</span><br><span class="line">        &#125;</span><br><span class="line">        ajax(<span class="string">&#x27;http://url-3&#x27;</span>, data3, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="keyword">return</span> handle(err);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> success(result);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>回调越多，代码越难看。</p>
<p>有了generator的美好时代，用AJAX时可以这么写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    r1 = <span class="keyword">yield</span> ajax(<span class="string">&#x27;http://url-1&#x27;</span>, data1);</span><br><span class="line">    r2 = <span class="keyword">yield</span> ajax(<span class="string">&#x27;http://url-2&#x27;</span>, data2);</span><br><span class="line">    r3 = <span class="keyword">yield</span> ajax(<span class="string">&#x27;http://url-3&#x27;</span>, data3);</span><br><span class="line">    success(r3);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    handle(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看上去是同步的代码，实际执行是异步的。tower文章：用Promise解决多个异步Ajax请求导致的代码嵌套问题(完美解决方案): <a target="_blank" rel="noopener" href="https://tower.im/projects/4a0f93625fb943c6b2b213bfe48cb651/docs/6361860e4c51483ca7d20f1c11a52507/">https://tower.im/projects/4a0f93625fb943c6b2b213bfe48cb651/docs/6361860e4c51483ca7d20f1c11a52507/</a></p>
<h1 id="创建Koa2工程"><a href="#创建Koa2工程" class="headerlink" title="创建Koa2工程"></a>创建Koa2工程</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入koa，和koa 1.x不同，在koa2中，我们导入的是一个class，因此用大写的Koa表示:</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个Koa对象表示web app本身:</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于任何请求，app将调用该异步函数处理请求：</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    ctx.response.type = <span class="string">&#x27;text/html&#x27;</span>;</span><br><span class="line">    ctx.response.body = <span class="string">&#x27;&lt;h1&gt;Hello, koa2!&lt;/h1&gt;&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在端口3000监听:</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;app started at port 3000...&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><mark>我</mark>：通过上面的代码，我大致的可以想象下，在Koa的来看，整个服务器端看成一个对象，这个对象就是Koa的实例，我们称之为web app。<br>它有个use方法，可以接受异步函数。<br>它有个listen方法，用来监听端口。<br>koa对象会自动将接受到的http请求的request和response封装到<code>ctx</code>中，然后将<code>ctx</code>对象传入我异步函数中，因此我们在koa对象的方法中可以直接用<code>ctx</code>这个对象来对respone和request做处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    <span class="comment">// 设置response的Content-Type:</span></span><br><span class="line">    ctx.response.type = <span class="string">&#x27;text/html&#x27;</span>;</span><br><span class="line">    <span class="comment">// 设置response的内容:</span></span><br><span class="line">    ctx.response.body = <span class="string">&#x27;&lt;h1&gt;Hello, koa2!&lt;/h1&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之前提到了ctx对象是Koa对象自行生成的，这里可以猜测next也是Koa生成的。<br>而且从<code>next()</code> 看出，它应该是函数，而且是<code>next</code>是koa传入的将要处理的下一个异步函数。在ES6语法中我们学过<code>await</code>这个命令，正常情况下，<code>await</code>命令后面是一个 Promise 对象。如果不是，会被<strong>转成</strong>一个立即<code>resolve</code>的 Promise 对象。 一般await写在一个<code>async</code>函数中，当只要一个<code>await</code>语句后面的 Promise 变为<code>reject</code>，那么整个<code>async</code>函数都会中断执行。 而这个<code>async</code>函数如果有<code>.catch</code> 的话，那么<code>.catch</code> 会接受到这个错误。<br>如果忘了<code>await</code>可以再看看阮一峰写的<a target="_blank" rel="noopener" href="http://es6.ruanyifeng.com/?search=await&amp;x=0&amp;y=0#docs/async">http://es6.ruanyifeng.com/?search=await&amp;x=0&amp;y=0#docs/async</a></p>
<p>回到koa，<code>next</code>跟在await后面，它是koa对象对下一个异步函数的封装。<br>我们在Koa的方法里面接受这个异步函数，用await将他转为Promise对象，并等待它的执行结果。（await是个语法糖，注意这里的等待是指这个异步函数在等待，异步函数之外的其他异步函数还是在执行的。这里要理解IO操作为何不需要CPU,IO和DMA芯片）</p>
<p>上面的这些是<mark>我</mark>个人的猜测。现在继续看廖雪峰怎么看的。<br>koa middleware，也就是中间件，我记得阮一峰将中间件描述为<code>request</code> 和 <code>response</code> 中间的功能物件，中间的让我们再仔细看看koa的执行逻辑。核心代码是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    ctx.response.type = <span class="string">&#x27;text/html&#x27;</span>;</span><br><span class="line">    ctx.response.body = <span class="string">&#x27;&lt;h1&gt;Hello, koa2!&lt;/h1&gt;&#x27;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>没接收到一个http请求，koa就会通过调用<code>app.use()</code> 注册的async函数并传入<code>ctx</code> 和 <code>next</code> 参数。<br>我们可以对<code>ctx</code> 操作，并设置返回内容。<br>为什么在这个异步函数中要调用<code>await next()</code> 呢？<br>原因是koa把许多async函数组成一个处理链，每个async函数都可以做一些自己事情，然后用<code>await next()</code> 来调用下一个async函数，我们把每个async函数称为middleware，这些middleware可以组合起来完成很多功能。<br><mark>我</mark>： 和我们之前的理解一样，koa生成的app实例,偷偷的做了好多事情。 </p>
<p>下列用3个Middleware组成处理链，此次打印日志，记录处理时间，输出到Html.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>`</span>); <span class="comment">// 打印URL</span></span><br><span class="line">    <span class="keyword">await</span> next(); <span class="comment">// 调用下一个middleware</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(); <span class="comment">// 当前时间</span></span><br><span class="line">    <span class="keyword">await</span> next(); <span class="comment">// 调用下一个middleware</span></span><br><span class="line">    <span class="keyword">const</span> ms = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime() - start; <span class="comment">// 耗费时间</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Time: <span class="subst">$&#123;ms&#125;</span>ms`</span>); <span class="comment">// 打印耗费时间</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    ctx.response.type = <span class="string">&#x27;text/html&#x27;</span>;</span><br><span class="line">    ctx.response.body = <span class="string">&#x27;&lt;h1&gt;Hello, koa2!&lt;/h1&gt;&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//代码执行的顺序被形容为洋葱模型。</span></span><br></pre></td></tr></table></figure>

<p>middleware的顺序很重要，也就是调用<code>app.use（）</code> 的顺序决定了Middleware的顺序，此外，如果一个middleware没有调用<code>await next()</code><br>后续的middleware将不在执行了，这种情况也很常见，例如，一个检测用户权限的middleware可以决定是否继续处理请求.还是直接返回403错误：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">await</span> checkUserPermission(ctx)) &#123;</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctx.response.status = <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>理解了middleware，我们就已经会用koa了！</p>
<p>最后注意<code>ctx</code>对象有一些简写的方法，例如<code>ctx.url</code>相当于<code>ctx.request.url</code>，<code>ctx.type</code>相当于<code>ctx.response.type</code>。</p>
<h1 id="处理URL"><a href="#处理URL" class="headerlink" title="处理URL"></a>处理URL</h1><p>在hello-koa工程中，我们处理http请求一律返回相同的HTML,这样虽然非常简单，但是用浏览器一测，随便输入任何URL都会相同的网页。</p>
<p>正常情况下，我们应该对不通的URL调用不同的处理函数，这样才能返回不同的结果。</p>
<p>如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.request.path === <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">&#x27;index page&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.request.path === <span class="string">&#x27;/test&#x27;</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">&#x27;TEST page&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.request.path === <span class="string">&#x27;/error&#x27;</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">&#x27;ERROR page&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>虽然这样写可以运行，但是有点蠢。</p>
<p>应该有个能集中处理URL的middleware，它根据不同的URL调用不同的处理函数，这样我们才能专心为每个URL编写处理函数。</p>
<h1 id="koa-router"><a href="#koa-router" class="headerlink" title="koa-router"></a>koa-router</h1><p>为了处理URL，我们需要引入<code>koa-router</code> middleware,让它负责处理URL映射。<br>现在<code>package.json</code> 中添加依赖项。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;koa-router&quot;</span> : <span class="string">&quot;版本号&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后用<code>npm install</code> 安装。</p>
<p>接下来,修改<code>app.js</code> 使用koa-router 来处理URL.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意require(&#x27;koa-router&#x27;)返回的是函数:</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// log request URL:</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Process <span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add url-route:</span></span><br><span class="line">router.get(<span class="string">&#x27;/hello/:name&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> name = ctx.params.name;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Hello, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.response.body = <span class="string">&#x27;&lt;h1&gt;Index&lt;/h1&gt;&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add router middleware:</span></span><br><span class="line">app.use(router.routes());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;app started at port 3000...&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>注意导入<code>koa-router</code> 的语句后面有一个<code>()</code> 是函数调用。</p>
<p>相当于</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fn_router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = fn_router();</span><br></pre></td></tr></table></figure>

<p>然后，我们使用<code>router.get(&#39;/path&#39;,async fn)</code> 来注册一个GET请求。可以在请求路径使用带变量的<code>/hello/:name</code>,变量可以通过<code>ctx.params.name</code>访问.</p>
<p>运行<code>app.js</code>  输入 <code>http://localhost:3000/hello/koa</code></p>
<p><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/0014711359603600e61e66425134339ade05501019c1f24000/l" alt="url-hello"></p>
<h1 id="处理POST请求"><a href="#处理POST请求" class="headerlink" title="处理POST请求"></a>处理POST请求</h1><p>用<code>router.get(&#39;/path&#39;, async fn)</code>处理的是get请求。如果要处理post请求，可以用<code>router.post(&#39;/path&#39;, async fn)</code>。 </p>
<p>处理post请求处理URL时，我们会遇到一个新问题，POST请求通常会发送一个表单，或者一个JSON,它作为request的body发送，但无论是node.js提供的原始request对象，还是koa提供的request对象，都不提供解析request的body功能。<br>所以我们需要引入另一个middleware来解析原始request请求，然后，把解析后的参数，绑定到<code>ctx.request.body</code> 中。</p>
<p><code>koa-bodyparser</code> 就是用来干这个的。</p>
<p>我们在<code>package.json</code>中添加依赖项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;koa-bodyparser&quot;</span>: <span class="string">&quot;3.2.0&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后使用<code>npm install</code>安装。</p>
<p>下面，修改<code>app.js</code>，引入<code>koa-bodyparser</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;koa-bodyparser&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>在合适的位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(bodyParser());</span><br></pre></td></tr></table></figure>

<p>由于中间件的位置很重要，这个<code>koa-bodyparser</code> 必须在<code>router</code> 之前被注册到<code>app</code> 对象上，我们就可以处理post请求了。写一个简单的表单登入。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">处理URL</span><br><span class="line">阅读: <span class="number">38382</span></span><br><span class="line">在hello-koa工程中，我们处理http请求一律返回相同的HTML，这样虽然非常简单，但是用浏览器一测，随便输入任何URL都会返回相同的网页。</span><br><span class="line"></span><br><span class="line">buduijin</span><br><span class="line"></span><br><span class="line">正常情况下，我们应该对不同的URL调用不同的处理函数，这样才能返回不同的结果。例如像这样写：</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.request.path === <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">&#x27;index page&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.request.path === <span class="string">&#x27;/test&#x27;</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">&#x27;TEST page&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.request.path === <span class="string">&#x27;/error&#x27;</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">&#x27;ERROR page&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">这么写是可以运行的，但是好像有点蠢。</span><br><span class="line"></span><br><span class="line">应该有一个能集中处理URL的middleware，它根据不同的URL调用不同的处理函数，这样，我们才能专心为每个URL编写处理函数。</span><br><span class="line"></span><br><span class="line">koa-router</span><br><span class="line">为了处理URL，我们需要引入koa-router这个middleware，让它负责处理URL映射。</span><br><span class="line"></span><br><span class="line">我们把上一节的hello-koa工程复制一份，重命名为url-koa。</span><br><span class="line"></span><br><span class="line">先在package.json中添加依赖项：</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;koa-router&quot;</span>: <span class="string">&quot;7.0.0&quot;</span></span><br><span class="line">然后用npm install安装。</span><br><span class="line"></span><br><span class="line">接下来，我们修改app.js，使用koa-router来处理URL：</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意require(&#x27;koa-router&#x27;)返回的是函数:</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// log request URL:</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Process <span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add url-route:</span></span><br><span class="line">router.get(<span class="string">&#x27;/hello/:name&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> name = ctx.params.name;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Hello, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.response.body = <span class="string">&#x27;&lt;h1&gt;Index&lt;/h1&gt;&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add router middleware:</span></span><br><span class="line">app.use(router.routes());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;app started at port 3000...&#x27;</span>);</span><br><span class="line">注意导入koa-router的语句最后的()是函数调用：</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)();</span><br><span class="line">相当于：</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fn_router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = fn_router();</span><br><span class="line">然后，我们使用router.get(<span class="string">&#x27;/path&#x27;</span>, <span class="keyword">async</span> fn)来注册一个GET请求。可以在请求路径中使用带变量的/hello/:name，变量可以通过ctx.params.name访问。</span><br><span class="line"></span><br><span class="line">再运行app.js，我们就可以测试不同的URL：</span><br><span class="line"></span><br><span class="line">输入首页：http:<span class="comment">//localhost:3000/</span></span><br><span class="line"></span><br><span class="line">url-index</span><br><span class="line"></span><br><span class="line">输入：http:<span class="comment">//localhost:3000/hello/koa</span></span><br><span class="line"></span><br><span class="line">url-hello</span><br><span class="line"></span><br><span class="line">处理post请求</span><br><span class="line">用router.get(<span class="string">&#x27;/path&#x27;</span>, <span class="keyword">async</span> fn)处理的是get请求。如果要处理post请求，可以用router.post(<span class="string">&#x27;/path&#x27;</span>, <span class="keyword">async</span> fn)。</span><br><span class="line"></span><br><span class="line">用post请求处理URL时，我们会遇到一个问题：post请求通常会发送一个表单，或者<span class="built_in">JSON</span>，它作为request的body发送，但无论是Node.js提供的原始request对象，还是koa提供的request对象，都不提供解析request的body的功能！</span><br><span class="line"></span><br><span class="line">所以，我们又需要引入另一个middleware来解析原始request请求，然后，把解析后的参数，绑定到ctx.request.body中。</span><br><span class="line"></span><br><span class="line">koa-bodyparser就是用来干这个活的。</span><br><span class="line"></span><br><span class="line">我们在package.json中添加依赖项：</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;koa-bodyparser&quot;</span>: <span class="string">&quot;3.2.0&quot;</span></span><br><span class="line">然后使用npm install安装。</span><br><span class="line"></span><br><span class="line">下面，修改app.js，引入koa-bodyparser：</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;koa-bodyparser&#x27;</span>);</span><br><span class="line">在合适的位置加上：</span><br><span class="line"></span><br><span class="line">app.use(bodyParser());</span><br><span class="line">由于middleware的顺序很重要，这个koa-bodyparser必须在router之前被注册到app对象上。</span><br><span class="line"></span><br><span class="line">现在我们就可以处理post请求了。写一个简单的登录表单：</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Index&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;form action=&quot;/signin&quot; method=&quot;post&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Name: &lt;input name=&quot;name&quot; value=&quot;koa&quot;&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Password: &lt;input name=&quot;password&quot; type=&quot;password&quot;&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/signin&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span></span><br><span class="line">        name = ctx.request.body.name || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        password = ctx.request.body.password || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`signin with name: <span class="subst">$&#123;name&#125;</span>, password: <span class="subst">$&#123;password&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (name === <span class="string">&#x27;koa&#x27;</span> &amp;&amp; password === <span class="string">&#x27;12345&#x27;</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">`&lt;h1&gt;Welcome, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctx.response.body = <span class="string">`&lt;h1&gt;Login failed!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;&lt;a href=&quot;/&quot;&gt;Try again&lt;/a&gt;&lt;/p&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>注意到我们用<code>var name = ctx.request.body.name || &#39;&#39;</code>拿到表单的<code>name</code>字段，如果该字段不存在，默认值设置为<code>&#39;&#39;</code>。</p>
<p>类似的，put、delete、head请求也可以由router处理。</p>
<h1 id="重构"><a href="#重构" class="headerlink" title="重构"></a>重构</h1><p>现在可以处理不同的URL了，但是看看<code>app.js</code> 觉得有点不对劲。<br>所有的URL处理函数都放到app.js中显得很乱。而且每加一个URL，就需要修改<code>app.js</code> ，随着URL越来越多。app.js会越来越长。处理URL</p>
<p>阅读: 38382</p>
<hr>
<p>在hello-koa工程中，我们处理http请求一律返回相同的HTML，这样虽然非常简单，但是用浏览器一测，随便输入任何URL都会返回相同的网页。</p>
<p><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/00147113484058028953e8afc024ecd804d19932fcbb7e4000/l" alt="buduijin"></p>
<p>正常情况下，我们应该对不同的URL调用不同的处理函数，这样才能返回不同的结果。例如像这样写：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">app.use(async (ctx, next) =&gt; &#123;</span><br><span class="line">    if (ctx.request.path === &#x27;/&#x27;) &#123;</span><br><span class="line">        ctx.response.body = &#x27;index page&#x27;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        await next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(async (ctx, next) =&gt; &#123;</span><br><span class="line">    if (ctx.request.path === &#x27;/test&#x27;) &#123;</span><br><span class="line">        ctx.response.body = &#x27;TEST page&#x27;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        await next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(async (ctx, next) =&gt; &#123;</span><br><span class="line">    if (ctx.request.path === &#x27;/error&#x27;) &#123;</span><br><span class="line">        ctx.response.body = &#x27;ERROR page&#x27;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        await next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这么写是可以运行的，但是好像有点蠢。</p>
<p>应该有一个能集中处理URL的middleware，它根据不同的URL调用不同的处理函数，这样，我们才能专心为每个URL编写处理函数。</p>
<h3 id="koa-router-1"><a href="#koa-router-1" class="headerlink" title="koa-router"></a>koa-router</h3><p>为了处理URL，我们需要引入<code>koa-router</code>这个middleware，让它负责处理URL映射。</p>
<p>我们把上一节的<code>hello-koa</code>工程复制一份，重命名为<code>url-koa</code>。</p>
<p>先在<code>package.json</code>中添加依赖项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;koa-router&quot;: &quot;7.0.0&quot;</span><br></pre></td></tr></table></figure>

<p>然后用<code>npm install</code>安装。</p>
<p>接下来，我们修改<code>app.js</code>，使用<code>koa-router</code>来处理URL：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意require(&#x27;koa-router&#x27;)返回的是函数:</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// log request URL:</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Process <span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add url-route:</span></span><br><span class="line">router.get(<span class="string">&#x27;/hello/:name&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> name = ctx.params.name;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Hello, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.response.body = <span class="string">&#x27;&lt;h1&gt;Index&lt;/h1&gt;&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add router middleware:</span></span><br><span class="line">app.use(router.routes());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;app started at port 3000...&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>注意导入<code>koa-router</code>的语句最后的<code>()</code>是函数调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const router = require(&#x27;koa-router&#x27;)();</span><br></pre></td></tr></table></figure>

<p>相当于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const fn_router = require(&#x27;koa-router&#x27;);</span><br><span class="line">const router = fn_router();</span><br></pre></td></tr></table></figure>

<p>然后，我们使用<code>router.get(&#39;/path&#39;, async fn)</code>来注册一个GET请求。可以在请求路径中使用带变量的<code>/hello/:name</code>，变量可以通过<code>ctx.params.name</code>访问。</p>
<p>再运行<code>app.js</code>，我们就可以测试不同的URL：</p>
<p>输入首页：<a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000/</a></p>
<p><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/00147113595193701793cd467444d4581422a767ffd2f7f000/l" alt="url-index"></p>
<p>输入：<a target="_blank" rel="noopener" href="http://localhost:3000/hello/koa">http://localhost:3000/hello/koa</a></p>
<p><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/0014711359603600e61e66425134339ade05501019c1f24000/l" alt="url-hello"></p>
<h3 id="处理post请求"><a href="#处理post请求" class="headerlink" title="处理post请求"></a>处理post请求</h3><p>用<code>router.get(&#39;/path&#39;, async fn)</code>处理的是get请求。如果要处理post请求，可以用<code>router.post(&#39;/path&#39;, async fn)</code>。</p>
<p>用post请求处理URL时，我们会遇到一个问题：post请求通常会发送一个表单，或者JSON，它作为request的body发送，但无论是Node.js提供的原始request对象，还是koa提供的request对象，都<em>不提供</em>解析request的body的功能！</p>
<p>所以，我们又需要引入另一个middleware来解析原始request请求，然后，把解析后的参数，绑定到<code>ctx.request.body</code>中。</p>
<p><code>koa-bodyparser</code>就是用来干这个活的。</p>
<p>我们在<code>package.json</code>中添加依赖项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;koa-bodyparser&quot;: &quot;3.2.0&quot;</span><br></pre></td></tr></table></figure>

<p>然后使用<code>npm install</code>安装。</p>
<p>下面，修改<code>app.js</code>，引入<code>koa-bodyparser</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const bodyParser = require(&#x27;koa-bodyparser&#x27;);</span><br></pre></td></tr></table></figure>

<p>在合适的位置加上：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(bodyParser());</span><br></pre></td></tr></table></figure>

<p>由于middleware的顺序很重要，这个<code>koa-bodyparser</code>必须在<code>router</code>之前被注册到<code>app</code>对象上。</p>
<p>现在我们就可以处理post请求了。写一个简单的登录表单：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Index&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;form action=&quot;/signin&quot; method=&quot;post&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Name: &lt;input name=&quot;name&quot; value=&quot;koa&quot;&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Password: &lt;input name=&quot;password&quot; type=&quot;password&quot;&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;`</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/signin&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span></span><br><span class="line">        name = ctx.request.body.name || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        password = ctx.request.body.password || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`signin with name: <span class="subst">$&#123;name&#125;</span>, password: <span class="subst">$&#123;password&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (name === <span class="string">&#x27;koa&#x27;</span> &amp;&amp; password === <span class="string">&#x27;12345&#x27;</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">`&lt;h1&gt;Welcome, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctx.response.body = <span class="string">`&lt;h1&gt;Login failed!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;&lt;a href=&quot;/&quot;&gt;Try again&lt;/a&gt;&lt;/p&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>注意到我们用<code>var name = ctx.request.body.name || &#39;&#39;</code>拿到表单的<code>name</code>字段，如果该字段不存在，默认值设置为<code>&#39;&#39;</code>。</p>
<p>类似的，put、delete、head请求也可以由router处理。</p>
<h3 id="重构-1"><a href="#重构-1" class="headerlink" title="重构"></a>重构</h3><p>现在，我们已经可以处理不同的URL了，但是看看<code>app.js</code>，总觉得还是有点不对劲。</p>
<p><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/0014711367359288798e3c3f90a4057ace65eb63c2e1544000/l" alt="still-buduijin"></p>
<p>所有的URL处理函数都放到<code>app.js</code>里显得很乱，而且，每加一个URL，就需要修改<code>app.js</code>。随着URL越来越多，<code>app.js</code>就会越来越长。</p>
<p>如果能把URL处理函数集中到某个js文件，或者某几个js文件中就好了，然后让<code>app.js</code>自动导入所有处理URL的函数。这样，代码一分离，逻辑就显得清楚了。最好是这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">url2-koa/</span><br><span class="line">|</span><br><span class="line">+- .vscode/</span><br><span class="line">|  |</span><br><span class="line">|  +- launch.json &lt;-- VSCode 配置文件</span><br><span class="line">|</span><br><span class="line">+- controllers/</span><br><span class="line">|  |</span><br><span class="line">|  +- login.js &lt;-- 处理login相关URL</span><br><span class="line">|  |</span><br><span class="line">|  +- users.js &lt;-- 处理用户管理相关URL</span><br><span class="line">|</span><br><span class="line">+- app.js &lt;-- 使用koa的js</span><br><span class="line">|</span><br><span class="line">+- package.json &lt;-- 项目描述文件</span><br><span class="line">|</span><br><span class="line">+- node_modules/ &lt;-- npm安装的所有依赖包</span><br></pre></td></tr></table></figure>

<p>于是我们把<code>url-koa</code>复制一份，重命名为<code>url2-koa</code>，准备重构这个项目。</p>
<p>我们先在<code>controllers</code>目录下编写<code>index.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fn_index = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Index&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;form action=&quot;/signin&quot; method=&quot;post&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Name: &lt;input name=&quot;name&quot; value=&quot;koa&quot;&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;Password: &lt;input name=&quot;password&quot; type=&quot;password&quot;&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">            &lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;`</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fn_signin = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span></span><br><span class="line">        name = ctx.request.body.name || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        password = ctx.request.body.password || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`signin with name: <span class="subst">$&#123;name&#125;</span>, password: <span class="subst">$&#123;password&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (name === <span class="string">&#x27;koa&#x27;</span> &amp;&amp; password === <span class="string">&#x27;12345&#x27;</span>) &#123;</span><br><span class="line">        ctx.response.body = <span class="string">`&lt;h1&gt;Welcome, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctx.response.body = <span class="string">`&lt;h1&gt;Login failed!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;&lt;a href=&quot;/&quot;&gt;Try again&lt;/a&gt;&lt;/p&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="string">&#x27;GET /&#x27;</span>: fn_index,</span><br><span class="line">    <span class="string">&#x27;POST /signin&#x27;</span>: fn_signin</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个<code>index.js</code>通过<code>module.exports</code>把两个URL处理函数暴露出来。</p>
<p>类似的，<code>hello.js</code>把一个URL处理函数暴露出来：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fn_hello = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> name = ctx.params.name;</span><br><span class="line">    ctx.response.body = <span class="string">`&lt;h1&gt;Hello, <span class="subst">$&#123;name&#125;</span>!&lt;/h1&gt;`</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="string">&#x27;GET /hello/:name&#x27;</span>: fn_hello</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>现在，我们修改<code>app.js</code>，让它自动扫描<code>controllers</code>目录，找到所有<code>js</code>文件，导入，然后注册每个URL： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先导入fs模块，然后用readdirSync列出文件</span></span><br><span class="line"><span class="comment">// 这里可以用sync是因为启动时只运行一次，不存在性能问题:</span></span><br><span class="line"><span class="keyword">var</span> files = fs.readdirSync(__dirname + <span class="string">&#x27;/controllers&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤出.js文件:</span></span><br><span class="line"><span class="keyword">var</span> js_files = files.filter(<span class="function">(<span class="params">f</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> f.endsWith(<span class="string">&#x27;.js&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理每个js文件:</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> f <span class="keyword">of</span> js_files) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`process controller: <span class="subst">$&#123;f&#125;</span>...`</span>);</span><br><span class="line">    <span class="comment">// 导入js文件:</span></span><br><span class="line">    <span class="keyword">let</span> mapping = <span class="built_in">require</span>(__dirname + <span class="string">&#x27;/controllers/&#x27;</span> + f);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> url <span class="keyword">in</span> mapping) &#123;</span><br><span class="line">        <span class="keyword">if</span> (url.startsWith(<span class="string">&#x27;GET &#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 如果url类似&quot;GET xxx&quot;:</span></span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">4</span>);</span><br><span class="line">            router.get(path, mapping[url]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`register URL mapping: GET <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.startsWith(<span class="string">&#x27;POST &#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 如果url类似&quot;POST xxx&quot;:</span></span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">5</span>);</span><br><span class="line">            router.post(path, mapping[url]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`register URL mapping: POST <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 无效的URL:</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`invalid URL: <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果上面的大段代码看起来还是有点费劲，那就把它拆成更小单元的函数： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addMapping</span>(<span class="params">router, mapping</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> url <span class="keyword">in</span> mapping) &#123;</span><br><span class="line">        <span class="keyword">if</span> (url.startsWith(<span class="string">&#x27;GET &#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">4</span>);</span><br><span class="line">            router.get(path, mapping[url]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`register URL mapping: GET <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url.startsWith(<span class="string">&#x27;POST &#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = url.substring(<span class="number">5</span>);</span><br><span class="line">            router.post(path, mapping[url]);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`register URL mapping: POST <span class="subst">$&#123;path&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`invalid URL: <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addControllers</span>(<span class="params">router</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> files = fs.readdirSync(__dirname + <span class="string">&#x27;/controllers&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> js_files = files.filter(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> f.endsWith(<span class="string">&#x27;.js&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> f <span class="keyword">of</span> js_files) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`process controller: <span class="subst">$&#123;f&#125;</span>...`</span>);</span><br><span class="line">        <span class="keyword">let</span> mapping = <span class="built_in">require</span>(__dirname + <span class="string">&#x27;/controllers/&#x27;</span> + f);</span><br><span class="line">        addMapping(router, mapping);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addControllers(router);</span><br></pre></td></tr></table></figure>

<p>确保每个函数功能都非常简单，一眼就能看明白，是代码可以维护的关键。</p>
<h1 id="Controller-Middleware"><a href="#Controller-Middleware" class="headerlink" title="Controller Middleware"></a>Controller Middleware</h1><p>最后，我们把扫描<code>controllers</code>目录和创建<code>router</code>的代码从<code>app.js</code>中提取出来，作为一个简单的mm,iddleware使用，命名为<code>controller.js</code>： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addMapping</span>(<span class="params">router, mapping</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addControllers</span>(<span class="params">router, dir</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">dir</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span></span><br><span class="line">        controllers_dir = dir || <span class="string">&#x27;controllers&#x27;</span>, <span class="comment">// 如果不传参数，扫描目录默认为&#x27;controllers&#x27;</span></span><br><span class="line">        router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)();</span><br><span class="line">    addControllers(router, controllers_dir);</span><br><span class="line">    <span class="keyword">return</span> router.routes();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接下里app.js的代码又简化了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入controller middleware:</span></span><br><span class="line"><span class="keyword">const</span> controller = <span class="built_in">require</span>(<span class="string">&#x27;./controller&#x27;</span>);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用middleware:</span></span><br><span class="line">app.use(controller());</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>经过重新整理后的工程<code>url2-koa</code>目前具备非常好的模块化，所有处理URL的函数按功能组存放在<code>controllers</code>目录，今后我们也只需要不断往这个目录下加东西就可以了，<code>app.js</code>保持不变。</p>
<h3 id="参考源码"><a href="#参考源码" class="headerlink" title="参考源码"></a>参考源码</h3><p><a target="_blank" rel="noopener" href="https://github.com/michaelliao/learn-javascript/tree/master/samples/node/web/koa/url-koa">url-koa</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/michaelliao/learn-javascript/tree/master/samples/node/web/koa/url2-koa">url2-koa</a></p>
<h1 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h1><p>运行程序的时候，数据都是在内存中的，当程序终止的时候，通常都需要将数据保存在磁盘上，无论是保存在本地磁盘，还是通过网络保存在服务器上，最终都会将数据写入磁盘文件。<br>而如何定义数据的存储格式就是一个大问题。如果我们自己来定义存储格式，如保存一个班级所有学生的成绩单。</p>
<table>
<thead>
<tr>
<th>名字</th>
<th>成绩</th>
</tr>
</thead>
<tbody><tr>
<td>Michael</td>
<td>99</td>
</tr>
<tr>
<td>Bob</td>
<td>85</td>
</tr>
<tr>
<td>Bart</td>
<td>59</td>
</tr>
<tr>
<td>Lisa</td>
<td>87</td>
</tr>
</tbody></table>
<p>可以用文本文件保存。一行保存一个学生，用<code>,</code>隔开</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Michael,<span class="number">99</span></span><br><span class="line">Bob,<span class="number">85</span></span><br><span class="line">Bart,<span class="number">59</span></span><br><span class="line">Lisa,<span class="number">87</span></span><br></pre></td></tr></table></figure>

<p>还可以用JSON格式保存。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;Michael&quot;</span>,<span class="attr">&quot;score&quot;</span>:<span class="number">99</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;Bob&quot;</span>,<span class="attr">&quot;score&quot;</span>:<span class="number">85</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;Bart&quot;</span>,<span class="attr">&quot;score&quot;</span>:<span class="number">59</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;Lisa&quot;</span>,<span class="attr">&quot;score&quot;</span>:<span class="number">87</span>&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>还可以定义各种保存格式，但是问题来了，存储和读取需要自己实现。JSON还是标准，自定义的格式就各式各样了。不能做到快速查询。只有把数据全部读到内存中才能自己遍历，但有时候数据的大小远远超过了内存，根本无法全部读入内存。</p>
<p>为了便于程序保存和读取数据，而且，能直接通过条件快速查询到指定的数据，就出现了数据库这种专门用于集中存储和查询的软件。</p>
<p>数据库软件诞生的历史非常久远，早在1950年数据库就诞生了，经历了网状数据库，层次数据库，我们现在广泛使用的关系数据库是20世纪70年代基于关系模型的基础上诞生的。</p>
<p>关系模型有一套复杂的数学理论，但是从概念上十分容易理解，举个学校的例子。假设某个XX省YY市ZZ县第一实验小学有3个年级，要表示出这3个年级，可以在Excel中用一个表格画出来： <img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/001398086641919935cabfda92c4152831892dcea5a4fa0000/0" alt="grade"></p>
<p>每个年级又有若干个班级，要把所有班级表示出来，可以在Excel中再画一个表格： </p>
<p><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/001398086656928fdad4552b9364589b2dfdfaf9f37f5af000/0" alt="class"></p>
<p>这两个表格有个映射关系，就是根据Grade_ID可以在班级表中查找到对应的所有班级： <img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/0013980867129633e8a2b06f258435cbf6b585360fe078b000/0" alt="grade-classes"></p>
<p>也就是Grade表的每一行对应Class表的多行，在关系数据库中，这种基于表（Table）的一对多的关系就是关系数据库的基础。 </p>
<p>根据某个年级的ID就可以查找所有班级的行，这种查询语句在关系数据库中称为SQL语句，可以写成： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> classes <span class="keyword">WHERE</span> grade_id <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>结果也是一个表： </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">---------+----------+----------</span><br><span class="line">grade_id | class_id | name</span><br><span class="line">---------+----------+----------</span><br><span class="line"><span class="number">1</span>        | <span class="number">11</span>       | 一年级一班</span><br><span class="line">---------+----------+----------</span><br><span class="line"><span class="number">1</span>        | <span class="number">12</span>       | 一年级二班</span><br><span class="line">---------+----------+----------</span><br><span class="line"><span class="number">1</span>        | <span class="number">13</span>       | 一年级三班</span><br><span class="line">---------+----------+----------</span><br></pre></td></tr></table></figure>

<p>类似的，Class表的一行记录又可以关联到Student表的多行记录： </p>
<p><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/001398086848421dd1e6eefa1284ab3885d219b81da7e13000/0" alt="class-students"></p>
<h1 id="NoSQL"><a href="#NoSQL" class="headerlink" title="NoSQL"></a>NoSQL</h1><p>你也许还听说过NoSQL数据库，很多NoSQL宣传其速度和规模远远超过关系数据库，所以很多同学觉得有了NoSQL是否就不需要SQL了呢？千万不要被他们忽悠了，连SQL都不明白怎么可能搞明白NoSQL呢？ </p>
<h1 id="数据库类别"><a href="#数据库类别" class="headerlink" title="数据库类别"></a>数据库类别</h1><p>既然我们要使用关系数据库，就必须选择一个关系数据库，目前广泛使用的关系数据库也就这么几种。mysql</p>
<p>阅读: 13434</p>
<hr>
<h3 id="访问数据库"><a href="#访问数据库" class="headerlink" title="访问数据库"></a>访问数据库</h3><p>程序运行的时候，数据都是在内存中的。当程序终止的时候，通常都需要将数据保存到磁盘上，无论是保存到本地磁盘，还是通过网络保存到服务器上，最终都会将数据写入磁盘文件。</p>
<p>而如何定义数据的存储格式就是一个大问题。如果我们自己来定义存储格式，比如保存一个班级所有学生的成绩单：</p>
<table>
<thead>
<tr>
<th>名字</th>
<th>成绩</th>
</tr>
</thead>
<tbody><tr>
<td>Michael</td>
<td>99</td>
</tr>
<tr>
<td>Bob</td>
<td>85</td>
</tr>
<tr>
<td>Bart</td>
<td>59</td>
</tr>
<tr>
<td>Lisa</td>
<td>87</td>
</tr>
</tbody></table>
<p>你可以用一个文本文件保存，一行保存一个学生，用<code>,</code>隔开：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Michael,99</span><br><span class="line">Bob,85</span><br><span class="line">Bart,59</span><br><span class="line">Lisa,87</span><br></pre></td></tr></table></figure>

<p>你还可以用JSON格式保存，也是文本文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;&quot;name&quot;:&quot;Michael&quot;,&quot;score&quot;:99&#125;,</span><br><span class="line">    &#123;&quot;name&quot;:&quot;Bob&quot;,&quot;score&quot;:85&#125;,</span><br><span class="line">    &#123;&quot;name&quot;:&quot;Bart&quot;,&quot;score&quot;:59&#125;,</span><br><span class="line">    &#123;&quot;name&quot;:&quot;Lisa&quot;,&quot;score&quot;:87&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>你还可以定义各种保存格式，但是问题来了：</p>
<p>存储和读取需要自己实现，JSON还是标准，自己定义的格式就各式各样了；</p>
<p>不能做快速查询，只有把数据全部读到内存中才能自己遍历，但有时候数据的大小远远超过了内存（比如蓝光电影，40GB的数据），根本无法全部读入内存。</p>
<p>为了便于程序保存和读取数据，而且，能直接通过条件快速查询到指定的数据，就出现了数据库（Database）这种专门用于集中存储和查询的软件。</p>
<p>数据库软件诞生的历史非常久远，早在1950年数据库就诞生了。经历了网状数据库，层次数据库，我们现在广泛使用的关系数据库是20世纪70年代基于关系模型的基础上诞生的。</p>
<p>关系模型有一套复杂的数学理论，但是从概念上是十分容易理解的。举个学校的例子：</p>
<p>假设某个XX省YY市ZZ县第一实验小学有3个年级，要表示出这3个年级，可以在Excel中用一个表格画出来：</p>
<p><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/001398086641919935cabfda92c4152831892dcea5a4fa0000/0" alt="grade"></p>
<p>每个年级又有若干个班级，要把所有班级表示出来，可以在Excel中再画一个表格：</p>
<p><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/001398086656928fdad4552b9364589b2dfdfaf9f37f5af000/0" alt="class"></p>
<p>这两个表格有个映射关系，就是根据Grade_ID可以在班级表中查找到对应的所有班级：</p>
<p><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/0013980867129633e8a2b06f258435cbf6b585360fe078b000/0" alt="grade-classes"></p>
<p>也就是Grade表的每一行对应Class表的多行，在关系数据库中，这种基于表（Table）的一对多的关系就是关系数据库的基础。</p>
<p>根据某个年级的ID就可以查找所有班级的行，这种查询语句在关系数据库中称为SQL语句，可以写成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM classes WHERE grade_id = &#x27;1&#x27;;</span><br></pre></td></tr></table></figure>

<p>结果也是一个表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">---------+----------+----------</span><br><span class="line">grade_id | class_id | name</span><br><span class="line">---------+----------+----------</span><br><span class="line">1        | 11       | 一年级一班</span><br><span class="line">---------+----------+----------</span><br><span class="line">1        | 12       | 一年级二班</span><br><span class="line">---------+----------+----------</span><br><span class="line">1        | 13       | 一年级三班</span><br><span class="line">---------+----------+----------</span><br></pre></td></tr></table></figure>

<p>类似的，Class表的一行记录又可以关联到Student表的多行记录：</p>
<p><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/001398086848421dd1e6eefa1284ab3885d219b81da7e13000/0" alt="class-students"></p>
<p>由于本教程不涉及到关系数据库的详细内容，如果你想从零学习关系数据库和基本的SQL语句，请自行搜索相关课程。</p>
<h3 id="NoSQL-1"><a href="#NoSQL-1" class="headerlink" title="NoSQL"></a>NoSQL</h3><p>你也许还听说过NoSQL数据库，很多NoSQL宣传其速度和规模远远超过关系数据库，所以很多同学觉得有了NoSQL是否就不需要SQL了呢？千万不要被他们忽悠了，连SQL都不明白怎么可能搞明白NoSQL呢？</p>
<h3 id="数据库类别-1"><a href="#数据库类别-1" class="headerlink" title="数据库类别"></a>数据库类别</h3><p>既然我们要使用关系数据库，就必须选择一个关系数据库。目前广泛使用的关系数据库也就这么几种：</p>
<p>付费的商用数据库：</p>
<ul>
<li>Oracle，典型的高富帅；</li>
<li>SQL Server，微软自家产品，Windows定制专款；</li>
<li>DB2，IBM的产品，听起来挺高端；</li>
<li>Sybase，曾经跟微软是好基友，后来关系破裂，现在家境惨淡。</li>
</ul>
<p>这些数据库都是不开源而且付费的，最大的好处是花了钱出了问题可以找厂家解决，不过在Web的世界里，常常需要部署成千上万的数据库服务器，当然不能把大把大把的银子扔给厂家，所以，无论是Google、Facebook，还是国内的BAT，无一例外都选择了免费的开源数据库：</p>
<ul>
<li>MySQL，大家都在用，一般错不了；</li>
<li>PostgreSQL，学术气息有点重，其实挺不错，但知名度没有MySQL高；</li>
<li>sqlite，嵌入式数据库，适合桌面和移动应用。</li>
</ul>
<p>作为一个JavaScript全栈工程师，选择哪个免费数据库呢？当然是MySQL。因为MySQL普及率最高，出了错，可以很容易找到解决方法。而且，围绕MySQL有一大堆监控和运维的工具，安装和使用很方便。</p>
<h3 id="安装MySQL"><a href="#安装MySQL" class="headerlink" title="安装MySQL"></a>安装MySQL</h3><p>为了能继续后面的学习，你需要从MySQL官方网站下载并安装<a target="_blank" rel="noopener" href="http://dev.mysql.com/downloads/mysql/">MySQL Community Server 5.6</a>，这个版本是免费的，其他高级版本是要收钱的（请放心，收钱的功能我们用不上）。MySQL是跨平台的，选择对应的平台下载安装文件，安装即可。</p>
<p>安装时，MySQL会提示输入<code>root</code>用户的口令，请务必记清楚。如果怕记不住，就把口令设置为<code>password</code>。</p>
<p>在Windows上，安装时请选择<code>UTF-8</code>编码，以便正确地处理中文。</p>
<p>在Mac或Linux上，需要编辑MySQL的配置文件，把数据库默认的编码全部改为UTF-8。MySQL的配置文件默认存放在<code>/etc/my.cnf</code>或者<code>/etc/mysql/my.cnf</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line"><span class="keyword">default</span>-character-set = utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="keyword">default</span>-storage-engine = INNODB</span><br><span class="line">character-set-server = utf8</span><br><span class="line">collation-server = utf8_general_ci</span><br></pre></td></tr></table></figure>

<p>重启MySQL后，可以通过MySQL的客户端命令行检查编码： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;%char%&#x27;</span>;</span><br><span class="line">+--------------------------+--------------------------------------------------------+</span><br><span class="line">| Variable_name            | Value                                                  |</span><br><span class="line">+--------------------------+--------------------------------------------------------+</span><br><span class="line">| character_set_client     | utf8                                                   |</span><br><span class="line">| character_set_connection | utf8                                                   |</span><br><span class="line">| character_set_database   | utf8                                                   |</span><br><span class="line">| character_set_filesystem | binary                                                 |</span><br><span class="line">| character_set_results    | utf8                                                   |</span><br><span class="line">| character_set_server     | utf8                                                   |</span><br><span class="line">| character_set_system     | utf8                                                   |</span><br><span class="line">| character_sets_dir       | /usr/<span class="built_in">local</span>/mysql-5.1.65-osx10.6-x86_64/share/charsets/ |</span><br><span class="line">+--------------------------+--------------------------------------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>看到<code>utf8</code>字样就表示编码设置正确。</p>
<p><em>注</em>：如果MySQL的版本≥5.5.3，可以把编码设置为<code>utf8mb4</code>，<code>utf8mb4</code>和<code>utf8</code>完全兼容，但它支持最新的Unicode标准，可以显示emoji字符。</p>
<h1 id="使用Sequelize"><a href="#使用Sequelize" class="headerlink" title="使用Sequelize"></a>使用Sequelize</h1><h1 id="访问MySQL"><a href="#访问MySQL" class="headerlink" title="访问MySQL"></a>访问MySQL</h1><p>当我们装好MySQL后，Node.js程序如何访问MySQL数据库呢？ </p>
<p>访问MySQL数据库的方法只有一种方法，就是通过网络发送SQL命令，然后，MySQL服务器执行后返回结果，我们可以在命令行窗口输入<code>mysql -u root -p</code>，然后输入root口令后，就连接到了MySQL服务器。因为没有指定<code>--host</code>参数，所以我们连接到的是<code>localhost</code>，也就是本机的MySQL服务器。 </p>
<p>在命令行窗口下，我们可以输入命令，操作MySQL服务器： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.05 sec)</span><br></pre></td></tr></table></figure>

<p>输入<code>exit</code>退出MySQL命令行模式。 </p>
<p>对于Node.js程序，访问MySQL也是通过网络发送SQL命令给MySQL服务器，这个访问MySQL服务器的软件包通常称为MySQL驱动程序，不同的编程语言需要实现自己的驱动MySQL官方提供了Java、.Net、Python、Node.js、C++和C的驱动程序，官方的Node.js驱动目前仅支持5.7以上版本，而我们上面使用的命令行程序实际上用的就是C驱动。 目前使用最广泛的MySQL Node.js驱动程序是开源的<code>mysql</code>，可以直接使用npm安装。 </p>
<h1 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h1><p>如果直接使用<code>mysql</code>包提供的接口，我们编写的代码就比较底层，例如，查询代码： </p>
<pre><code>                                                                                                                                                                                                                                             <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">&#x27;SELECT * FROM users WHERE id = ?&#x27;</span>, [<span class="string">&#x27;123&#x27;</span>], <span class="function"><span class="keyword">function</span>(<span class="params">err, rows</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="comment">// error</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> row <span class="keyword">in</span> rows) &#123;</span><br><span class="line">            processRow(row);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</code></pre>
<p>考虑到数据库表是一个二维表，包含多行多列，例如一个<code>pets</code>的表： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from pets;</span><br><span class="line">+----+--------+------------+</span><br><span class="line">| id | name   | birth      |</span><br><span class="line">+----+--------+------------+</span><br><span class="line">|  1 | Gaffey | 2007-07-07 |</span><br><span class="line">|  2 | Odie   | 2008-08-08 |</span><br><span class="line">+----+--------+------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="使用Sequelize-1"><a href="#使用Sequelize-1" class="headerlink" title="使用Sequelize"></a>使用Sequelize</h4><p>阅读: 32624</p>
<hr>
<h3 id="访问MySQL-1"><a href="#访问MySQL-1" class="headerlink" title="访问MySQL"></a>访问MySQL</h3><p>当我们安装好MySQL后，Node.js程序如何访问MySQL数据库呢？</p>
<p>访问MySQL数据库只有一种方法，就是通过网络发送SQL命令，然后，MySQL服务器执行后返回结果。</p>
<p>我们可以在命令行窗口输入<code>mysql -u root -p</code>，然后输入root口令后，就连接到了MySQL服务器。因为没有指定<code>--host</code>参数，所以我们连接到的是<code>localhost</code>，也就是本机的MySQL服务器。</p>
<p>在命令行窗口下，我们可以输入命令，操作MySQL服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.05 sec)</span><br></pre></td></tr></table></figure>

<p>输入<code>exit</code>退出MySQL命令行模式。</p>
<p>对于Node.js程序，访问MySQL也是通过网络发送SQL命令给MySQL服务器。这个访问MySQL服务器的软件包通常称为MySQL驱动程序。不同的编程语言需要实现自己的驱动，MySQL官方提供了Java、.Net、Python、Node.js、C++和C的驱动程序，官方的Node.js驱动目前仅支持5.7以上版本，而我们上面使用的命令行程序实际上用的就是C驱动。</p>
<p>目前使用最广泛的MySQL Node.js驱动程序是开源的<code>mysql</code>，可以直接使用npm安装。</p>
<h3 id="ORM-1"><a href="#ORM-1" class="headerlink" title="ORM"></a>ORM</h3><p>如果直接使用<code>mysql</code>包提供的接口，我们编写的代码就比较底层，例如，查询代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">connection.query(&#x27;SELECT * FROM users WHERE id = ?&#x27;, [&#x27;123&#x27;], function(err, rows) &#123;</span><br><span class="line">    if (err) &#123;</span><br><span class="line">        // error</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        for (let row in rows) &#123;</span><br><span class="line">            processRow(row);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>考虑到数据库表是一个二维表，包含多行多列，例如一个<code>pets</code>的表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from pets;</span><br><span class="line">+----+--------+------------+</span><br><span class="line">| id | name   | birth      |</span><br><span class="line">+----+--------+------------+</span><br><span class="line">|  1 | Gaffey | 2007-07-07 |</span><br><span class="line">|  2 | Odie   | 2008-08-08 |</span><br><span class="line">+----+--------+------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>每一行可以用一个JavaScript对象表示，例如第一行：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Gaffey&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;birth&quot;</span>: <span class="string">&quot;2007-07-07&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就是传说中的ORM技术：Object-Relational Mapping，把关系数据库的表结构映射到对象上。是不是很简单？</p>
<p>但是由谁来做这个转换呢？所以ORM框架应运而生。</p>
<p>我们选择Node的ORM框架Sequelize来操作数据库。这样，我们读写的都是JavaScript对象，Sequelize帮我们把对象变成数据库中的行。</p>
<p>用Sequelize查询<code>pets</code>表，代码像这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Pet.findAll()</span><br><span class="line">   .then(function (pets) &#123;</span><br><span class="line">       for (let pet in pets) &#123;</span><br><span class="line">           console.log(`$&#123;pet.id&#125;: $&#123;pet.name&#125;`);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;).catch(function (err) &#123;</span><br><span class="line">       // error</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>

<p>因为Sequelize返回的对象是Promise，所以我们可以用<code>then()</code>和<code>catch()</code>分别异步响应成功和失败。</p>
<p>但是用<code>then()</code>和<code>catch()</code>仍然比较麻烦。有没有更简单的方法呢？</p>
<p>可以用ES7的await来调用任何一个Promise对象，这样我们写出来的代码就变成了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pets = <span class="keyword">await</span> Pet.findAll();</span><br></pre></td></tr></table></figure>

<p>真的就是这么简单！</p>
<p>await只有一个限制，就是必须在async函数中调用。上面的代码直接运行还差一点，我们可以改成：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> pets = <span class="keyword">await</span> Pet.findAll();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>考虑到koa的处理函数都是async函数，所以我们实际上将来在koa的async函数中直接写await访问数据库就可以了！</p>
<p>这也是为什么我们选择Sequelize的原因：只要API返回Promise，就可以用await调用，写代码就非常简单！</p>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><p>在使用Sequlize操作数据库之前，我们先在MySQL中创建一个表来测试。我们可以在<code>test</code>数据库中创建一个<code>pets</code>表。<code>test</code>数据库是MySQL安装后自动创建的用于测试的数据库。在MySQL命令行执行下列命令： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> test.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;www&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;www&#x27;</span>;</span><br><span class="line"></span><br><span class="line">use test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> pets (</span><br><span class="line">    id <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    gender bool <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    birth <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    createdAt <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    updatedAt <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    version <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    <span class="keyword">primary</span> key (id)</span><br><span class="line">) engine<span class="operator">=</span>innodb;</span><br></pre></td></tr></table></figure>

<p>第一条<code>grant</code>命令是创建MySQL的用户名和口令，均为<code>www</code>，并赋予操作<code>test</code>数据库的所有权限。</p>
<p>第二条<code>use</code>命令把当前数据库切换为<code>test</code>。</p>
<p>第三条命令创建了<code>pets</code>表。</p>
<p>然后，我们根据前面的工程结构创建<code>hello-sequelize</code>工程，结构如下：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">hello-sequelize/</span><br><span class="line">|</span><br><span class="line">+- .vscode/</span><br><span class="line">|  |</span><br><span class="line">|  +- launch.json &lt;-- VSCode 配置文件</span><br><span class="line">|</span><br><span class="line">+- init.txt &lt;-- 初始化SQL命令</span><br><span class="line">|</span><br><span class="line">+- config.js &lt;-- MySQL配置文件</span><br><span class="line">|</span><br><span class="line">+- app.js &lt;-- 使用koa的js</span><br><span class="line">|</span><br><span class="line">+- package.json &lt;-- 项目描述文件</span><br><span class="line">|</span><br><span class="line">+- node_modules/ &lt;-- npm安装的所有依赖包</span><br></pre></td></tr></table></figure>

<p>然后，添加如下依赖包： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;sequelize&quot;</span>: <span class="string">&quot;3.24.1&quot;</span>,</span><br><span class="line"><span class="string">&quot;mysql&quot;</span>: <span class="string">&quot;2.11.1&quot;</span></span><br></pre></td></tr></table></figure>

<p>注意<code>mysql</code>是驱动，我们不直接使用，但是<code>sequelize</code>会用。</p>
<p>用<code>npm install</code>安装。</p>
<p><code>config.js</code>实际上是一个简单的配置文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">    <span class="attr">database</span>: <span class="string">&#x27;test&#x27;</span>, <span class="comment">// 使用哪个数据库</span></span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;www&#x27;</span>, <span class="comment">// 用户名</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;www&#x27;</span>, <span class="comment">// 口令</span></span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>, <span class="comment">// 主机名</span></span><br><span class="line">    <span class="attr">port</span>: <span class="number">3306</span> <span class="comment">// 端口号，MySQL默认3306</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config;</span><br></pre></td></tr></table></figure>

<p>下面，我们就可以在<code>app.js</code>中操作数据库了。使用Sequelize操作MySQL需要先做两件准备工作：</p>
<p>第一步，创建一个sequelize对象实例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Sequelize = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sequelize = <span class="keyword">new</span> Sequelize(config.database, config.username, config.password, &#123;</span><br><span class="line">    <span class="attr">host</span>: config.host,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="attr">pool</span>: &#123;</span><br><span class="line">        <span class="attr">max</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">min</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">idle</span>: <span class="number">30000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>第二步，定义模型Pet，告诉Sequelize如何映射数据库表： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Pet = sequelize.define(<span class="string">&#x27;pet&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: Sequelize.STRING(<span class="number">50</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">name</span>: Sequelize.STRING(<span class="number">100</span>),</span><br><span class="line">    <span class="attr">gender</span>: Sequelize.BOOLEAN,</span><br><span class="line">    <span class="attr">birth</span>: Sequelize.STRING(<span class="number">10</span>),</span><br><span class="line">    <span class="attr">createdAt</span>: Sequelize.BIGINT,</span><br><span class="line">    <span class="attr">updatedAt</span>: Sequelize.BIGINT,</span><br><span class="line">    <span class="attr">version</span>: Sequelize.BIGINT</span><br><span class="line">&#125;, &#123;</span><br><span class="line">        <span class="attr">timestamps</span>: <span class="literal">false</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>用<code>sequelize.define()</code>定义Model时，传入名称<code>pet</code>，默认的表名就是<code>pets</code>。第二个参数指定列名和数据类型，如果是主键，需要更详细地指定。第三个参数是额外的配置，我们传入<code>&#123; timestamps: false &#125;</code>是为了关闭Sequelize的自动添加timestamp的功能。所有的ORM框架都有一种很不好的风气，总是自作聪明地加上所谓“自动化”的功能，但是会让人感到完全摸不着头脑。</p>
<p>接下来，我们就可以往数据库中塞一些数据了。我们可以用Promise的方式写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> now = <span class="built_in">Date</span>.now();</span><br><span class="line"></span><br><span class="line">Pet.create(&#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&#x27;g-&#x27;</span> + now,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Gaffey&#x27;</span>,</span><br><span class="line">    <span class="attr">gender</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">birth</span>: <span class="string">&#x27;2007-07-07&#x27;</span>,</span><br><span class="line">    <span class="attr">createdAt</span>: now,</span><br><span class="line">    <span class="attr">updatedAt</span>: now,</span><br><span class="line">    <span class="attr">version</span>: <span class="number">0</span></span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span> (<span class="params">p</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;created.&#x27;</span> + <span class="built_in">JSON</span>.stringify(p));</span><br><span class="line">&#125;).catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;failed: &#x27;</span> + err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>也可以用await写。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> dog = <span class="keyword">await</span> Pet.create(&#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&#x27;d-&#x27;</span> + now,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;Odie&#x27;</span>,</span><br><span class="line">        <span class="attr">gender</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">birth</span>: <span class="string">&#x27;2008-08-08&#x27;</span>,</span><br><span class="line">        <span class="attr">createdAt</span>: now,</span><br><span class="line">        <span class="attr">updatedAt</span>: now,</span><br><span class="line">        <span class="attr">version</span>: <span class="number">0</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;created: &#x27;</span> + <span class="built_in">JSON</span>.stringify(dog));</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>显然await代码更胜一筹。</p>
<p>查询数据时，用await写法如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> pets = <span class="keyword">await</span> Pet.findAll(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;Gaffey&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`find <span class="subst">$&#123;pets.length&#125;</span> pets:`</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> p <span class="keyword">of</span> pets) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(p));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>如果要更新数据，可以对查询到的实例调用<code>save()</code>方法： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> p = <span class="keyword">await</span> queryFromSomewhere();</span><br><span class="line">    p.gender = <span class="literal">true</span>;</span><br><span class="line">    p.updatedAt = <span class="built_in">Date</span>.now();</span><br><span class="line">    p.version ++;</span><br><span class="line">    <span class="keyword">await</span> p.save();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>如果要删除数据，可以对查询到的实例调用<code>destroy()</code>方法： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> p = <span class="keyword">await</span> queryFromSomewhere();</span><br><span class="line">    <span class="keyword">await</span> p.destroy();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>运行代码，可以看到Sequelize打印出的每一个SQL语句，便于我们查看： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Executing (<span class="keyword">default</span>): <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `pets` (`id`,`name`,`gender`,`birth`,`createdAt`,`updatedAt`,`version`) <span class="keyword">VALUES</span> (<span class="string">&#x27;g-1471961204219&#x27;</span>,<span class="string">&#x27;Gaffey&#x27;</span>,<span class="literal">false</span>,<span class="string">&#x27;2007-07-07&#x27;</span>,<span class="number">1471961204219</span>,<span class="number">1471961204219</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h3><p>我们把通过<code>sequelize.define()</code>返回的<code>Pet</code>称为Model，它表示一个数据模型。</p>
<p>我们把通过<code>Pet.findAll()</code>返回的一个或一组对象称为Model实例，每个实例都可以直接通过<code>JSON.stringify</code>序列化为JSON字符串。但是它们和普通JSON对象相比，多了一些由Sequelize添加的方法，比如<code>save()</code>和<code>destroy()</code>。调用这些方法我们可以执行更新或者删除操作。</p>
<p>所以，使用Sequelize操作数据库的一般步骤就是：</p>
<p>首先，通过某个Model对象的<code>findAll()</code>方法获取实例；</p>
<p>如果要更新实例，先对实例属性赋新值，再调用<code>save()</code>方法；</p>
<p>如果要删除实例，直接调用<code>destroy()</code>方法。</p>
<p>注意<code>findAll()</code>方法可以接收<code>where</code>、<code>order</code>这些参数，这和将要生成的SQL语句是对应的。</p>
<h4 id="建立Model"><a href="#建立Model" class="headerlink" title="建立Model"></a>建立Model</h4><p>直接使用Sequelize虽然可以，但是存在一些问题。</p>
<p>团队开发时，有人喜欢自己加timestamp：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Pet = sequelize.define(<span class="string">&#x27;pet&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: Sequelize.STRING(<span class="number">50</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">name</span>: Sequelize.STRING(<span class="number">100</span>),</span><br><span class="line">    <span class="attr">createdAt</span>: Sequelize.BIGINT,</span><br><span class="line">    <span class="attr">updatedAt</span>: Sequelize.BIGINT</span><br><span class="line">&#125;, &#123;</span><br><span class="line">        <span class="attr">timestamps</span>: <span class="literal">false</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>有人又喜欢自增主键，并且自定义表名： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Pet = sequelize.define(<span class="string">&#x27;pet&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: Sequelize.INTEGER,</span><br><span class="line">        <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">name</span>: Sequelize.STRING(<span class="number">100</span>)</span><br><span class="line">&#125;, &#123;</span><br><span class="line">        <span class="attr">tableName</span>: <span class="string">&#x27;t_pet&#x27;</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>一个大型Web App通常都有几十个映射表，一个映射表就是一个Model。如果按照各自喜好，那业务代码就不好写。Model不统一，很多代码也无法复用。</p>
<p>所以我们需要一个统一的模型，强迫所有Model都遵守同一个规范，这样不但实现简单，而且容易统一风格。</p>
<p>我们首先要定义的就是Model存放的文件夹必须在<code>models</code>内，并且以Model名字命名，例如：<code>Pet.js</code>，<code>User.js</code>等等。 </p>
<p>其次，每个Model必须遵守一套规范：</p>
<ol>
<li>统一主键，名称必须是<code>id</code>，类型必须是<code>STRING(50)</code>；</li>
<li>主键可以自己指定，也可以由框架自动生成（如果为null或undefined）；</li>
<li>所有字段默认为<code>NOT NULL</code>，除非显式指定；</li>
<li>统一timestamp机制，每个Model必须有<code>createdAt</code>、<code>updatedAt</code>和<code>version</code>，分别记录创建时间、修改时间和版本号。其中，<code>createdAt</code>和<code>updatedAt</code>以<code>BIGINT</code>存储时间戳，最大的好处是无需处理时区，排序方便。<code>version</code>每次修改时自增。</li>
</ol>
<p>所以，我们不要直接使用Sequelize的API，而是通过<code>db.js</code>间接地定义Model。例如，<code>User.js</code>应该定义如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;../db&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = db.defineModel(<span class="string">&#x27;users&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">email</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: db.STRING(<span class="number">100</span>),</span><br><span class="line">        <span class="attr">unique</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">passwd</span>: db.STRING(<span class="number">100</span>),</span><br><span class="line">    <span class="attr">name</span>: db.STRING(<span class="number">100</span>),</span><br><span class="line">    <span class="attr">gender</span>: db.BOOLEAN</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这样，User就具有<code>email</code>、<code>passwd</code>、<code>name</code>和<code>gender</code>这4个业务字段。<code>id</code>、<code>createdAt</code>、<code>updatedAt</code>和<code>version</code>应该自动加上，而不是每个Model都去重复定义。</p>
<p>所以，<code>db.js</code>的作用就是统一Model的定义：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Sequelize = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;init sequelize...&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sequelize = <span class="keyword">new</span> Sequelize(<span class="string">&#x27;dbname&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="attr">pool</span>: &#123;</span><br><span class="line">        <span class="attr">max</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">min</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">idle</span>: <span class="number">10000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ID_TYPE = Sequelize.STRING(<span class="number">50</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineModel</span>(<span class="params">name, attributes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> attrs = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> attributes) &#123;</span><br><span class="line">        <span class="keyword">let</span> value = attributes[key];</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;object&#x27;</span> &amp;&amp; value[<span class="string">&#x27;type&#x27;</span>]) &#123;</span><br><span class="line">            value.allowNull = value.allowNull || <span class="literal">false</span>;</span><br><span class="line">            attrs[key] = value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            attrs[key] = &#123;</span><br><span class="line">                <span class="attr">type</span>: value,</span><br><span class="line">                <span class="attr">allowNull</span>: <span class="literal">false</span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    attrs.id = &#123;</span><br><span class="line">        <span class="attr">type</span>: ID_TYPE,</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span></span><br><span class="line">    &#125;;</span><br><span class="line">    attrs.createdAt = &#123;</span><br><span class="line">        <span class="attr">type</span>: Sequelize.BIGINT,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">    attrs.updatedAt = &#123;</span><br><span class="line">        <span class="attr">type</span>: Sequelize.BIGINT,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">    attrs.version = &#123;</span><br><span class="line">        <span class="attr">type</span>: Sequelize.BIGINT,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> sequelize.define(name, attrs, &#123;</span><br><span class="line">        <span class="attr">tableName</span>: name,</span><br><span class="line">        <span class="attr">timestamps</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">hooks</span>: &#123;</span><br><span class="line">            <span class="attr">beforeValidate</span>: <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">let</span> now = <span class="built_in">Date</span>.now();</span><br><span class="line">                <span class="keyword">if</span> (obj.isNewRecord) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!obj.id) &#123;</span><br><span class="line">                        obj.id = generateId();</span><br><span class="line">                    &#125;</span><br><span class="line">                    obj.createdAt = now;</span><br><span class="line">                    obj.updatedAt = now;</span><br><span class="line">                    obj.version = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    obj.updatedAt = <span class="built_in">Date</span>.now();</span><br><span class="line">                    obj.version++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们定义的<code>defineModel</code>就是为了强制实现上述规则。</p>
<p>Sequelize在创建、修改Entity时会调用我们指定的函数，这些函数通过<code>hooks</code>在定义Model时设定。我们在<code>beforeValidate</code>这个事件中根据是否是<code>isNewRecord</code>设置主键（如果主键为<code>null</code>或<code>undefined</code>）、设置时间戳和版本号。</p>
<p>这么一来，Model定义的时候就可以大大简化。</p>
<h3 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h3><p>接下来，我们把简单的<code>config.js</code>拆成3个配置文件：</p>
<ul>
<li>config-default.js：存储默认的配置；</li>
<li>config-override.js：存储特定的配置；</li>
<li>config-test.js：存储用于测试的配置。</li>
</ul>
<p>例如，默认的<code>config-default.js</code>可以配置如下： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="attr">database</span>: <span class="string">&#x27;nodejs&#x27;</span>,</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;www&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;www&#x27;</span>,</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">3306</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config;</span><br></pre></td></tr></table></figure>

<p>而<code>config-override.js</code>可应用实际配置： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">    <span class="attr">database</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;www&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;secret-password&#x27;</span>,</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;192.168.1.199&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config;</span><br></pre></td></tr></table></figure>

<p><code>config-test.js</code>可应用测试环境的配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">    <span class="attr">database</span>: <span class="string">&#x27;test&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config;</span><br></pre></td></tr></table></figure>

<p>读取配置的时候，我们用<code>config.js</code>实现不同环境读取不同的配置文件： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> defaultConfig = <span class="string">&#x27;./config-default.js&#x27;</span>;</span><br><span class="line"><span class="comment">// 可设定为绝对路径，如 /opt/product/config-override.js</span></span><br><span class="line"><span class="keyword">const</span> overrideConfig = <span class="string">&#x27;./config-override.js&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> testConfig = <span class="string">&#x27;./config-test.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> config = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">&#x27;test&#x27;</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Load <span class="subst">$&#123;testConfig&#125;</span>...`</span>);</span><br><span class="line">    config = <span class="built_in">require</span>(testConfig);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Load <span class="subst">$&#123;defaultConfig&#125;</span>...`</span>);</span><br><span class="line">    config = <span class="built_in">require</span>(defaultConfig);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fs.statSync(overrideConfig).isFile()) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">`Load <span class="subst">$&#123;overrideConfig&#125;</span>...`</span>);</span><br><span class="line">            config = <span class="built_in">Object</span>.assign(config, <span class="built_in">require</span>(overrideConfig));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`Cannot load <span class="subst">$&#123;overrideConfig&#125;</span>.`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config;</span><br></pre></td></tr></table></figure>

<p>具体的规则是：</p>
<ol>
<li>先读取<code>config-default.js</code>；</li>
<li>如果不是测试环境，就读取<code>config-override.js</code>，如果文件不存在，就忽略。</li>
<li>如果是测试环境，就读取<code>config-test.js</code>。</li>
</ol>
<p>这样做的好处是，开发环境下，团队统一使用默认的配置，并且无需<code>config-override.js</code>。部署到服务器时，由运维团队配置好<code>config-override.js</code>，以覆盖<code>config-override.js</code>的默认设置。测试环境下，本地和CI服务器统一使用<code>config-test.js</code>，测试数据库可以反复清空，不会影响开发。</p>
<p>配置文件表面上写起来很容易，但是，既要保证开发效率，又要避免服务器配置文件泄漏，还要能方便地执行测试，就需要一开始搭建出好的结构，才能提升工程能力 </p>
<h3 id="使用Model"><a href="#使用Model" class="headerlink" title="使用Model"></a>使用Model</h3><p>要使用Model，就需要引入对应的Model文件，例如：<code>User.js</code>。一旦Model多了起来，如何引用也是一件麻烦事。</p>
<p>自动化永远比手工做效率高，而且更可靠。我们写一个<code>model.js</code>，自动扫描并导入所有Model：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;./db&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> files = fs.readdirSync(__dirname + <span class="string">&#x27;/models&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> js_files = files.filter(<span class="function">(<span class="params">f</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> f.endsWith(<span class="string">&#x27;.js&#x27;</span>);</span><br><span class="line">&#125;, files);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> f <span class="keyword">of</span> js_files) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`import model from file <span class="subst">$&#123;f&#125;</span>...`</span>);</span><br><span class="line">    <span class="keyword">let</span> name = f.substring(<span class="number">0</span>, f.length - <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">module</span>.exports[name] = <span class="built_in">require</span>(__dirname + <span class="string">&#x27;/models/&#x27;</span> + f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.sync = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    db.sync();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这样，需要用的时候，写起来就像这样： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> model = <span class="built_in">require</span>(<span class="string">&#x27;./model&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span></span><br><span class="line">    Pet = model.Pet,</span><br><span class="line">    User = model.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pet = <span class="keyword">await</span> Pet.create(&#123; ... &#125;);</span><br></pre></td></tr></table></figure>

<p>最终，我们创建的工程<code>model-sequelize</code>结构如下： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">model-sequelize/</span><br><span class="line">|</span><br><span class="line">+- .vscode/</span><br><span class="line">|  |</span><br><span class="line">|  +- launch.json &lt;-- VSCode 配置文件</span><br><span class="line">|</span><br><span class="line">+- models/ &lt;-- 存放所有Model</span><br><span class="line">|  |</span><br><span class="line">|  +- Pet.js &lt;-- Pet</span><br><span class="line">|  |</span><br><span class="line">|  +- User.js &lt;-- User</span><br><span class="line">|</span><br><span class="line">+- config.js &lt;-- 配置文件入口</span><br><span class="line">|</span><br><span class="line">+- config-default.js &lt;-- 默认配置文件</span><br><span class="line">|</span><br><span class="line">+- config-test.js &lt;-- 测试配置文件</span><br><span class="line">|</span><br><span class="line">+- db.js &lt;-- 如何定义Model</span><br><span class="line">|</span><br><span class="line">+- model.js &lt;-- 如何导入Model</span><br><span class="line">|</span><br><span class="line">+- init-db.js &lt;-- 初始化数据库</span><br><span class="line">|</span><br><span class="line">+- app.js &lt;-- 业务代码</span><br><span class="line">|</span><br><span class="line">+- package.json &lt;-- 项目描述文件</span><br><span class="line">|</span><br><span class="line">+- node_modules/ &lt;-- npm安装的所有依赖包</span><br></pre></td></tr></table></figure>

<p>注意到我们其实不需要创建表的SQL，因为Sequelize提供了一个<code>sync()</code>方法，可以自动创建数据库。这个功能在开发和生产环境中没有什么用，但是在测试环境中非常有用。测试时，我们可以用<code>sync()</code>方法自动创建出表结构，而不是自己维护SQL脚本。这样，可以随时修改Model的定义，并立刻运行测试。开发环境下，首次使用<code>sync()</code>也可以自动创建出表结构，避免了手动运行SQL的问题。 </p>
<p><code>init-db.js</code>的代码非常简单：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> model = <span class="built_in">require</span>(<span class="string">&#x27;./model.js&#x27;</span>);</span><br><span class="line">model.sync();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;init db ok.&#x27;</span>);</span><br><span class="line">process.exit(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>它最大的好处是避免了手动维护一个SQL脚本。</p>
<h3 id="参考源码-1"><a href="#参考源码-1" class="headerlink" title="参考源码"></a>参考源码</h3><p><a target="_blank" rel="noopener" href="https://github.com/michaelliao/learn-javascript/tree/master/samples/node/web/db/model-sequelize">model-sequelize</a> </p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">JINxo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2021/10/20/koa%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%BB%96%E9%9B%AA%E5%B3%B0/">http://example.com/2021/10/20/koa%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%BB%96%E9%9B%AA%E5%B3%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/koa2/">koa2</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/10/20/koa%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">koa基础</div></div></a></div><div class="next-post pull-right"><a href="/2021/10/20/js%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">表单验证</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">JINxo</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">54</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">23</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.</span> <span class="toc-text">基础回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#generator"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">generator</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAKoa2%E5%B7%A5%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">创建Koa2工程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%84%E7%90%86URL"><span class="toc-number">3.</span> <span class="toc-text">处理URL</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#koa-router"><span class="toc-number">4.</span> <span class="toc-text">koa-router</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%84%E7%90%86POST%E8%AF%B7%E6%B1%82"><span class="toc-number">5.</span> <span class="toc-text">处理POST请求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%87%8D%E6%9E%84"><span class="toc-number">6.</span> <span class="toc-text">重构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#koa-router-1"><span class="toc-number">6.0.1.</span> <span class="toc-text">koa-router</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86post%E8%AF%B7%E6%B1%82"><span class="toc-number">6.0.2.</span> <span class="toc-text">处理post请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%9E%84-1"><span class="toc-number">6.0.3.</span> <span class="toc-text">重构</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Controller-Middleware"><span class="toc-number">7.</span> <span class="toc-text">Controller Middleware</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%BA%90%E7%A0%81"><span class="toc-number">7.0.1.</span> <span class="toc-text">参考源码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mysql"><span class="toc-number">8.</span> <span class="toc-text">Mysql</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NoSQL"><span class="toc-number">9.</span> <span class="toc-text">NoSQL</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B1%BB%E5%88%AB"><span class="toc-number">10.</span> <span class="toc-text">数据库类别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">10.0.1.</span> <span class="toc-text">访问数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NoSQL-1"><span class="toc-number">10.0.2.</span> <span class="toc-text">NoSQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B1%BB%E5%88%AB-1"><span class="toc-number">10.0.3.</span> <span class="toc-text">数据库类别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85MySQL"><span class="toc-number">10.0.4.</span> <span class="toc-text">安装MySQL</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Sequelize"><span class="toc-number">11.</span> <span class="toc-text">使用Sequelize</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEMySQL"><span class="toc-number">12.</span> <span class="toc-text">访问MySQL</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ORM"><span class="toc-number">13.</span> <span class="toc-text">ORM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Sequelize-1"><span class="toc-number">13.0.0.1.</span> <span class="toc-text">使用Sequelize</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEMySQL-1"><span class="toc-number">13.0.1.</span> <span class="toc-text">访问MySQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ORM-1"><span class="toc-number">13.0.2.</span> <span class="toc-text">ORM</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">14.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Model"><span class="toc-number">14.0.1.</span> <span class="toc-text">Model</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8BModel"><span class="toc-number">14.0.1.1.</span> <span class="toc-text">建立Model</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">14.0.2.</span> <span class="toc-text">数据库配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Model"><span class="toc-number">14.0.3.</span> <span class="toc-text">使用Model</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%BA%90%E7%A0%81-1"><span class="toc-number">14.0.4.</span> <span class="toc-text">参考源码</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/12/01/CAS%E7%B3%BB%E7%BB%9F%E6%80%9D%E8%80%83%E6%B3%95/" title="思维"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="思维"/></a><div class="content"><a class="title" href="/2021/12/01/CAS%E7%B3%BB%E7%BB%9F%E6%80%9D%E8%80%83%E6%B3%95/" title="思维">思维</a><time datetime="2021-12-01T06:21:52.000Z" title="Created 2021-12-01 14:21:52">2021-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/10/%E5%A4%A7%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF%E6%8E%A2%E7%B4%A2/" title="大前端技术探索"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="大前端技术探索"/></a><div class="content"><a class="title" href="/2021/11/10/%E5%A4%A7%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF%E6%8E%A2%E7%B4%A2/" title="大前端技术探索">大前端技术探索</a><time datetime="2021-11-10T06:21:52.000Z" title="Created 2021-11-10 14:21:52">2021-11-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/06/%E6%9F%90%E6%89%8B%E6%B8%B8%E8%87%AA%E5%8A%A8%E5%AF%B9%E5%B1%80/" title="某手游自动对局"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="某手游自动对局"/></a><div class="content"><a class="title" href="/2021/11/06/%E6%9F%90%E6%89%8B%E6%B8%B8%E8%87%AA%E5%8A%A8%E5%AF%B9%E5%B1%80/" title="某手游自动对局">某手游自动对局</a><time datetime="2021-11-06T15:45:56.775Z" title="Created 2021-11-06 23:45:56">2021-11-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/11/03/%E5%90%8E%E5%8F%B0%E5%88%B7%E5%88%86/" title="某手游后台刷分"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="某手游后台刷分"/></a><div class="content"><a class="title" href="/2021/11/03/%E5%90%8E%E5%8F%B0%E5%88%B7%E5%88%86/" title="某手游后台刷分">某手游后台刷分</a><time datetime="2021-11-03T15:25:34.536Z" title="Created 2021-11-03 23:25:34">2021-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/10/30/%E5%8A%A8%E7%94%BB%E5%BA%8F%E5%88%97%E5%B8%A7/" title="No title"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/2021/10/30/%E5%8A%A8%E7%94%BB%E5%BA%8F%E5%88%97%E5%B8%A7/" title="No title">No title</a><time datetime="2021-10-30T15:51:40.216Z" title="Created 2021-10-30 23:51:40">2021-10-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By JINxo</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>